<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="WinDash2.Views.WidgetEditPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:WinDash2.Views"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:WinDash2.Models"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"
    mc:Ignorable="d">

    <Grid Padding="20">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto" MinWidth="200"/>
            <ColumnDefinition Width="Auto" />
            <!-- GridSplitter width -->
            <ColumnDefinition Width="*" MinWidth="400"/>
        </Grid.ColumnDefinitions>

        <!-- Preview WebView on the left -->
        <Grid Grid.Column="0" Margin="0,0,20,0">
            <WebView2 x:Name="PreviewWebView"/>
            
            <!-- Native placeholder shown when no URL is set -->
            <Border x:Name="PlaceholderPanel" 
                    Background="{ThemeResource LayerFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Visibility="Collapsed"
                    Padding="60">
                <StackPanel VerticalAlignment="Center" 
                           HorizontalAlignment="Center"
                           Spacing="12"
                           MaxWidth="400">
                    <FontIcon Glyph="&#xE8A7;" 
                             FontSize="48" 
                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                    <TextBlock Text="No URL Specified" 
                              FontSize="20" 
                              FontWeight="SemiBold"
                              Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                              HorizontalAlignment="Center"/>
                    <TextBlock Text="Enter a valid URL to preview the widget" 
                              FontSize="14" 
                              Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                              HorizontalAlignment="Center"
                              TextWrapping="Wrap"
                              TextAlignment="Center"/>
                </StackPanel>
            </Border>
        </Grid>

        <!-- Resizable splitter -->
        <controls:GridSplitter Grid.Column="1"
                               Width="1"
                               Background="{ThemeResource DividerStrokeColorDefaultBrush}"
                               ResizeBehavior="PreviousAndNext"
                               ResizeDirection="Columns" />

        <!-- Form on the right -->
        <ScrollViewer Grid.Column="2" Padding="20,0,0,0">
            <StackPanel Spacing="16">
                <!-- Header with Back Button -->
                <Grid Margin="0,0,0,20">
                    <Button Click="Cancel_Click" 
                            HorizontalAlignment="Left"
                            VerticalAlignment="Top"
                            Background="Transparent"
                            BorderThickness="0"
                            Padding="0"
                            Height="32">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE72B;" FontSize="14"/>
                            <TextBlock Text="Back" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <TextBlock x:Name="PageTitle"
                               Text="Edit Widget" 
                               FontSize="24" 
                               FontWeight="Bold" 
                               HorizontalAlignment="Left"
                               Margin="0,48,0,0"/>
                    <Button x:Name="OpenFolderButton"
                            Click="OpenWidgetFolder_Click"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Top"
                            Margin="0,48,0,0"
                            ToolTipService.ToolTip="Open Widget Folder"
                            Height="32"
                            Visibility="Collapsed">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE8DA;" FontSize="14"/>
                            <TextBlock Text="Open Folder" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </Grid>

                <!-- Basic Info Section -->
                <StackPanel Spacing="12">
                    <!-- Name input with favicon -->
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Header -->
                        <TextBlock Grid.Row="0" 
                                   Text="Name" 
                                   Margin="0,0,0,4"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                   FontSize="12"/>
                        
                        <!-- Composite control: Image + TextBox -->
                        <Grid Grid.Row="1">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            
                            <!-- Favicon Image -->
                            <Image x:Name="NameFaviconImage"
                                   Grid.Column="0"
                                   Width="16"
                                   Height="16"
                                   Margin="10,0,0,0"
                                   VerticalAlignment="Center"
                                   Visibility="Collapsed"/>
                            
                            <!-- Favicon Loading Spinner -->
                            <ProgressRing x:Name="FaviconSpinner"
                                         Grid.Column="0"
                                         Width="16"
                                         Height="16"
                                         Margin="10,0,0,0"
                                         VerticalAlignment="Center"
                                         Visibility="Collapsed"
                                         IsActive="True"/>
                            
                            <!-- TextBox with adjusted left padding when favicon is visible -->
                            <TextBox x:Name="NameTextBox"
                                     Grid.Column="0"
                                     Grid.ColumnSpan="2"
                                     Text="{x:Bind Widget.Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                     TextChanged="OnInputChanged"/>
                        </Grid>
                    </Grid>
                </StackPanel>

                <!-- Source Section -->
                <StackPanel Spacing="12">
                    <TextBlock Text="Source" FontSize="14" FontWeight="SemiBold" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"/>
                    <TextBox x:Name="UrlTextBox" Header="URL" Text="{x:Bind Widget.Url, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" TextChanged="OnUrlOrHtmlChanged" />
                    <TextBox x:Name="HtmlTextBox" Header="HTML" Text="{x:Bind Widget.Html, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" TextChanged="OnUrlOrHtmlChanged" />
                </StackPanel>

                <!-- Sizing Section -->
                <StackPanel Spacing="12">
                    <TextBlock Text="Sizing" FontSize="14" FontWeight="SemiBold" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"/>
                    <Grid ColumnSpacing="12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBox Grid.Column="0" Header="Width" Text="{x:Bind Widget.Width, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" TextChanged="OnInputChanged" />
                        <TextBox Grid.Column="1" Header="Height" Text="{x:Bind Widget.Height, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" TextChanged="OnInputChanged" />
                    </Grid>
                </StackPanel>

                <!-- Touch Section -->
                <StackPanel Spacing="12">
                    <TextBlock Text="Input Settings" FontSize="14" FontWeight="SemiBold" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"/>
                    <ToggleSwitch x:Name="TouchEnabledSwitch" Header="Touch Enabled" Toggled="TouchEnabledSwitch_Toggled" OnContent="" OffContent=""/>
                </StackPanel>

                <!-- Custom Favicon Section -->
                <StackPanel Spacing="8">
                    <TextBlock Text="Custom Favicon" FontSize="14" FontWeight="SemiBold" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"/>
                    <TextBlock Text="Use a custom icon file instead of auto-detecting from the website." 
                               FontSize="12" 
                               Foreground="{ThemeResource TextFillColorSecondaryBrush}" 
                               TextWrapping="Wrap"/>
                    
                    <!-- Show custom favicon status when set -->
                    <Border x:Name="CustomFaviconIndicator"
                            Background="{ThemeResource LayerFillColorDefaultBrush}"
                            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                            BorderThickness="1"
                            CornerRadius="4"
                            Padding="12,8"
                            Visibility="Collapsed">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <FontIcon Grid.Column="0" 
                                     Glyph="&#xE73E;" 
                                     FontSize="16" 
                                     Foreground="{ThemeResource AccentFillColorDefaultBrush}"
                                     Margin="0,0,8,0"
                                     VerticalAlignment="Center"/>
                            <TextBlock Grid.Column="1" 
                                      x:Name="CustomFaviconFilename"
                                      Text="custom-favicon.ico"
                                      VerticalAlignment="Center"
                                      TextTrimming="CharacterEllipsis"/>
                        </Grid>
                    </Border>
                    
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Click="BrowseFavicon_Click"
                                Height="32">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon Glyph="&#xE8B7;" FontSize="14"/>
                                <TextBlock Text="Browse for Favicon"/>
                            </StackPanel>
                        </Button>
                        <Button x:Name="DeleteCustomFaviconButton"
                                Click="DeleteCustomFavicon_Click"
                                Height="32"
                                Visibility="Collapsed"
                                ToolTipService.ToolTip="Delete Custom Favicon">
                            <FontIcon Glyph="&#xE74D;" FontSize="14"/>
                        </Button>
                    </StackPanel>
                </StackPanel>

                <!-- Custom User Agents Section -->
                <StackPanel Spacing="8">
                    <TextBlock Text="Custom User Agents" FontSize="14" FontWeight="SemiBold" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"/>
                    <TextBlock Text="Override user agent strings for specific domains to control how websites identify the browser." 
                               FontSize="12" 
                               Foreground="{ThemeResource TextFillColorSecondaryBrush}" 
                               TextWrapping="Wrap"/>
                    
                    <ItemsControl x:Name="UserAgentsList" ItemsSource="{x:Bind Widget.CustomUserAgent, Mode=OneWay}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="models:UserAgentMapping">
                                <Grid Margin="0,4">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="8"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="8"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <TextBox Grid.Column="0" 
                                             PlaceholderText="Domain (e.g., audible)"
                                             Text="{x:Bind Domain, Mode=TwoWay}"/>
                                    <TextBox Grid.Column="2" 
                                             PlaceholderText="User Agent String"
                                             Text="{x:Bind UserAgent, Mode=TwoWay}"/>
                                    <Button Grid.Column="4" 
                                            ToolTipService.ToolTip="Remove"
                                            Click="RemoveUserAgent_Click"
                                            Tag="{x:Bind}"
                                            Width="32"
                                            Height="32"
                                            Padding="4">
                                        <FontIcon Glyph="&#xE74D;" FontSize="16" Foreground="#E74856"/>
                                    </Button>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    
                    <Button Click="AddUserAgent_Click"
                            HorizontalAlignment="Stretch"
                            Height="32">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE710;" FontSize="14"/>
                            <TextBlock Text="Add User Agent"/>
                        </StackPanel>
                    </Button>
                </StackPanel>

                <!-- Force In Current Tab Section -->
                <StackPanel Spacing="8">
                    <TextBlock Text="Force In Current Tab" FontSize="14" FontWeight="SemiBold" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"/>
                    <TextBlock Text="URL patterns to open in current tab instead of new windows. Use * as wildcard." 
                               FontSize="12" 
                               Foreground="{ThemeResource TextFillColorSecondaryBrush}" 
                               TextWrapping="Wrap"/>
                    
                    <ItemsControl x:Name="ForceInCurrentTabList" ItemsSource="{x:Bind ForceInCurrentTabPatterns, Mode=OneWay}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="models:ForceInCurrentTabPattern">
                                <Grid Margin="0,4">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="8"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <TextBox Grid.Column="0" 
                                             PlaceholderText="URL Pattern (e.g., /webplayer or */foo* or *)" 
                                             Text="{x:Bind Pattern, Mode=TwoWay}"/>
                                    <Button Grid.Column="2" 
                                            ToolTipService.ToolTip="Remove"
                                            Click="RemoveForceInCurrentTab_Click"
                                            Tag="{x:Bind}"
                                            Width="32"
                                            Height="32"
                                            Padding="4">
                                        <FontIcon Glyph="&#xE74D;" FontSize="16" Foreground="#E74856"/>
                                    </Button>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    
                    <Button Click="AddForceInCurrentTab_Click"
                            HorizontalAlignment="Stretch"
                            Height="32">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE710;" FontSize="14"/>
                            <TextBlock Text="Add Pattern"/>
                        </StackPanel>
                    </Button>
                </StackPanel>

                <!-- Action Buttons -->
                <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,8,0,0">
                    <Button x:Name="SaveButton" Click="Save_Click" Style="{StaticResource AccentButtonStyle}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE74E;" FontSize="14"/>
                            <TextBlock Text="Save"/>
                        </StackPanel>
                    </Button>
                    <Button Click="Cancel_Click">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE711;" FontSize="14"/>
                            <TextBlock Text="Cancel"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</Page>
